---
import { Code as AstroCode } from "astro:components";
import clsx from "clsx";
import { balanced } from "@isaacs/balanced-match";
import { codeToHtml, type BundledLanguage } from "shiki";
import {
  transformerMetaWordHighlight,
  transformerRemoveLineBreak,
} from "@shikijs/transformers";

interface Props {
  code: string;
  lang: BundledLanguage;
  lineNumbers?: boolean;
  height?: number;
}

const { code, lang, lineNumbers = true, height } = Astro.props;

const highlightedCode = (code: string) => {
  const refMatch = /ref={|:ref="|{@attach /.exec(code);
  if (!refMatch) {
    return "";
  }
  const pair: [string, string] =
    refMatch[0] === ':ref="' ? ['"', '"'] : ["{", "}"];
  const pairMatch = balanced(...pair, code.slice(refMatch.index));
  if (!pairMatch) {
    throw new Error("Unbalanced pair");
  }
  return code.slice(refMatch.index, refMatch.index + pairMatch.end + 1);
};

// This is what gets green highlights
const meta = [
  highlightedCode(code),
  ...[
    'import { tabs } from "slidytabs";',
    'import { slider } from "slidytabs";',
    'import { slider, type SliderOptions } from "slidytabs";',
    'import { range, type RangeValue } from "slidytabs";',
  ].flatMap((item) => [item, `  ${item}`]),
]
  .map((item) => `/${item}/`)
  .join("");

const html = codeToHtml(code, {
  lang,
  theme: "github-light",
  rootStyle: `height: ${height}px;`,
  meta: {
    __raw: meta,
    class: clsx([
      // test small scolling widths before adjusting this
      "text-sm py-5 bg-muted h-full overflow-auto astro-code [&_.line]:(px-6 block) [&>code]:(inline-block min-w-max w-full)",
      lineNumbers && "line-numbers",
    ]),
  },
  transformers: [transformerMetaWordHighlight(), transformerRemoveLineBreak()],
});
---

<Fragment set:html={html} />

<!-- <AstroCode
  style={`height: ${height}px;`}
  {lang}
  theme="github-light"
  {code}
  {meta}
  transformers={[transformerMetaWordHighlight(), transformerRemoveLineBreak()]}
  class:list={[
    "text-sm py-5 bg-muted! h-full overflow-scroll .astro-code [&_.line]:(px-6 block)",
    lineNumbers && "line-numbers",
  ]}
/> -->

<style is:global>
  .astro-code {
    counter-reset: step;
    counter-increment: step 0;
  }
  :not(.line-numbers).astro-code .line::before {
    display: none;
  }
  .astro-code .line::before {
    content: counter(step);
    counter-increment: step;
    width: 1rem;
    margin-right: 1.5rem;
    display: inline-block;
    text-align: right;
    color: rgba(115, 138, 148, 0.4);
  }
</style>
