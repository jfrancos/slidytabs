---
import Code from "./Code.astro";
import SvelteShell from "../frameworks/svelte/Shell.svelte";
import TsxShell from "../frameworks/react/Shell.tsx";
import VueShell from "../frameworks/vue/Shell.vue";
import { icons } from "../lib/utils";
import {
  extractTsx,
  extractSvelte,
  extractVue,
  extractAstro,
} from "../lib/findHighlight.ts";
import type { Framework } from "$lib/store";
const { react, svelte, vue, astro } = icons;

interface Props {
  filename: string;
  framework: Framework;
}

const { filename, framework } = Astro.props;
const lang = framework === "react" ? "tsx" : framework;
const { default: Component } = await import(
  `../frameworks/${framework}/examples/${filename}.${lang}`
);
const { default: raw } = await import(
  `../frameworks/${framework}/examples/${filename}.${lang}?raw`
);

const { highlightFn, prefix, logo } = {
  react: {
    highlightFn: extractTsx,
    prefix: `// ${filename}.tsx`,
    logo: react,
  },
  svelte: {
    highlightFn: extractSvelte,
    prefix: `<!-- ${filename}.svelte -->`,
    logo: svelte,
  },
  vue: {
    highlightFn: extractVue,
    prefix: `<!-- ${filename}.vue -->`,
    logo: vue,
  },
  astro: {
    highlightFn: extractAstro,
    prefix: `// ${filename}.astro`,
    logo: astro,
  },
}[framework];
const code =
  framework === "astro"
    ? raw
        .split("\n")
        .filter((line: string) => !line.startsWith("// @ts-expect-error"))
        .toSpliced(1, 0, prefix)
        .join("\n")
    : `${prefix}\n${raw}`;
const highlight = await highlightFn(code);
---

<div
  class="flex flex-col border-gray-100 border-4 rounded-lg max-w-[calc(100vw-4rem)] w-2xl relative"
>
  <div class="flex justify-center h-32 items-center relative select-none">
    <div
      class:list={[
        logo,
        "text-xl absolute top-4 right-4 z-10 md:opacity-100 opacity-50",
      ]}
    >
    </div>
    {lang === "svelte" && <SvelteShell {filename} client:idle />}
    {lang === "tsx" && <TsxShell {filename} client:idle />}
    {lang === "vue" && <VueShell {filename} client:idle />}
    <!-- flash between SSR awaited component and client awaited component so we
    have both simultaneously and hide the SSR once the client is visible: -->
    <div class="[:has(*)~&]:hidden">
      <Component />
    </div>
  </div>
  <Code {highlight} {code} {lang} />
</div>
