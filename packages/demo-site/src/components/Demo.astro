---
import { range } from "@isaacs/balanced-match";
import Code from "./Code.astro";
import SvelteShell from "@/frameworks/svelte/Shell.svelte";
import TsxShell from "@/frameworks/react/Shell.tsx";
import VueShell from "@/frameworks/vue/Shell.vue";
import { icons } from "@/lib/utils";


export const extractVueCode = (code: string) => {
  const start = code.indexOf(':ref="')
  const end = range('"', '"', code.slice(start))?.[1] ?? 0;
  return code.slice(start, end + start + 1)
};

export const extractTsxCode = (code: string) => {
  const start = code.indexOf("ref={")
  const end = range("{", "}", code.slice(start))?.[1] ?? 0;
    return code.slice(start, end+ start + 1)
};

export const extractSvelteCode = (code: string) => {
  const start = code.indexOf("{@attach ")
  const end = range("{", "}", code.slice(start))?.[1] ?? 0;
    return code.slice(start, end + start + 1)
};

import type { Framework } from "@/lib/store";

// import fs from "node:fs/promises";
// import path from "node:path";
// import test from "../frameworks/react/examples/DoubleSliders.tsx?raw";
// console.log(test);

const { react, svelte, vue } = icons;
// const { react, svelte, vue, astro } = icons;

interface Props {
  filename: string;
  framework: Framework;
  raw: string;
  minLines: number;
}

const { filename, framework, raw, minLines } = Astro.props;
const lang = framework === "react" ? "tsx" : framework;
const { default: Component } = await import(
  `../frameworks/${framework}/examples/${filename}.${lang}`
);

// const raw = await fs.readFile(
//   path.resolve(
//     new URL(".", import.meta.url).pathname,
//     `../frameworks/${framework}/examples/${filename}.${lang}`
//   ),
//   "utf8"
// );

// TODO ?raw files are preprocessed by unocss transformers
// ^fs.readFile causes SSR flash and doesn't work in build
// const { default: raw } = await import(
//   `../frameworks/${framework}/examples/${filename}.${lang}?raw`
// );



const { prefix, logo, highlightFnCode } = {
  react: {
    highlightFnCode: extractTsxCode,
    prefix: `// ${filename}.tsx`,
    logo: react,
  },
  svelte: {
    highlightFnCode: extractSvelteCode,
    prefix: `<!-- ${filename}.svelte -->`,
    logo: svelte,
  },
  vue: {
    highlightFnCode: extractVueCode,
    prefix: `<!-- ${filename}.vue -->`,
    logo: vue,
  },
  // astro: {
  //   highlightFn: extractAstro,
  //   prefix: `// ${filename}.astro`,
  //   logo: astro,
  // },
}[framework];
const code = `${prefix}\n${raw.slice(0, -1)}`;
const height = 40 + minLines * 20;
// const code =
//   framework === "astro"
//     ? raw
//         .split("\n")
//         .filter((line: string) => !line.startsWith("// @ts-expect-error"))
//         .toSpliced(1, 0, prefix)
//         .join("\n")
//     : `${prefix}\n${raw}`;
const highlightedCode = highlightFnCode(code)
// console.log(highlightedCode)

const wip = filename==="Sticky" && framework === "vue"
---

<div
  class:list={["flex flex-col border-gray-100 rounded-lg relative transition-opacity", !wip && "border-4 "]}
  data-docs={`${filename}:${framework}`}
>
{ wip ? "Coming soon ..." : 
  <div class:list={["flex justify-center items-center relative select-none", filename === "Sticky" ? "h-40" : "h-32"]}>
    <div
      class:list={[
        logo,
        "text-xl absolute top-4 right-4 z-10 sm:opacity-100 opacity-50",
      ]}
    >
    </div>
    {lang === "svelte" && <SvelteShell {filename} client:idle />}
    {lang === "vue" && <VueShell {filename} client:idle />}
    {lang === "tsx" && <TsxShell {filename} client:idle />}
    <!-- flash between SSR awaited component and client awaited component so we
  have both simultaneously and hide the SSR once the client is visible: -->
    <div class="[:has(*)~&]:hidden">
      <Component />
    </div>
  </div>
  <Code {code} {lang} {height} {highlightedCode} />}
</div>
