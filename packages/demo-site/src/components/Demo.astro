---
import { balanced } from "@isaacs/balanced-match";
import Code from "./Code.astro";
import SvelteShell from "@/frameworks/svelte/Shell.svelte";
import TsxShell from "@/frameworks/react/Shell.tsx";
import VueShell from "@/frameworks/vue/Shell.vue";
import { icons } from "@/lib/utils";
import type { Framework } from "@/lib/store";

const getRefToken = (code: string) => {
  const refMatch = /ref={|:ref="|{@attach /.exec(code);
  if (!refMatch) {
    return "";
  }
  const pair: [string, string] =
    refMatch[0] === ':ref="' ? ['"', '"'] : ["{", "}"];
  const pairMatch = balanced(...pair, code.slice(refMatch.index));
  if (!pairMatch) {
    throw new Error("Unbalanced pair");
  }
  return code.slice(refMatch.index, refMatch.index + pairMatch.end + 1);
};

const { react, svelte, vue } = icons;

interface Props {
  filename: string;
  framework: Framework;
  raw: string;
  minLines: number;
}

const { filename, framework, raw, minLines } = Astro.props;
const lang = framework === "react" ? "tsx" : framework;
const { default: Component } = await import(
  `../frameworks/${framework}/examples/${filename}.${lang}`
);

// TODO ?raw files are preprocessed by unocss transformers
// ^fs.readFile causes SSR flash and doesn't work in build
// const { default: raw } = await import(
//   `../frameworks/${framework}/examples/${filename}.${lang}?raw`
// );

const { prefix, logo } = {
  react: {
    prefix: `// ${filename}.tsx`,
    logo: react,
  },
  svelte: {
    prefix: `<!-- ${filename}.svelte -->`,
    logo: svelte,
  },
  vue: {
    prefix: `<!-- ${filename}.vue -->`,
    logo: vue,
  },
}[framework];
const code = `${prefix}\n${raw.slice(0, -1)}`;
const height = 40 + minLines * 20;
// const code =
//   framework === "astro"
//     ? raw
//         .split("\n")
//         .filter((line: string) => !line.startsWith("// @ts-expect-error"))
//         .toSpliced(1, 0, prefix)
//         .join("\n")
//     : `${prefix}\n${raw}`;
const highlightedCode = getRefToken(code);

const wip = filename === "Sticky" && framework === "vue";
---

<div
  class:list={[
    "flex flex-col border-gray-100 rounded-lg relative transition-opacity",
    !wip && "border-4 ",
  ]}
  data-docs={`${filename}:${framework}`}
>
  <div class:list={[wip || "hidden"]}>Coming soon ...</div>
  <div
    class:list={[
      "flex justify-center items-center relative select-none",
      wip && "hidden",
      filename === "Sticky" ? "h-40" : "h-32",
    ]}
  >
    <div
      class:list={[
        logo,
        "text-xl absolute top-4 right-4 z-10 sm:opacity-100 opacity-50",
      ]}
    >
    </div>
    {lang === "svelte" && <SvelteShell {filename} client:idle />}
    {lang === "vue" && <VueShell {filename} client:idle />}
    {lang === "tsx" && <TsxShell {filename} client:idle />}
    <!-- flash between SSR awaited component and client awaited component so we
  have both simultaneously and hide the SSR once the client is visible: -->
    <div class="[:has(*)~&]:hidden">
      <Component />
    </div>
  </div>
  <div class:list={[wip && "hidden"]}>
    <Code {code} {lang} {height} {highlightedCode} />
  </div>
</div>
